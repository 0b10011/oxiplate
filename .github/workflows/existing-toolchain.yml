name: existing-toolchain

on:
  workflow_call:
    outputs:
      toolchain:
        description: "Rust toolchain currently in use"
        value: ${{ jobs.toolchain.outputs.toolchain }}

jobs:
  toolchain:
    runs-on: ubuntu-latest
    outputs:
      toolchain: ${{ steps.toolchain.outputs.toolchain }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Get current toolchain
        id: toolchain
        run: |
          TOOLCHAIN="$(cat ./.current-toolchain)"

          SAFE_REGEX='^[a-z0-9-]+$'
          if [[ ! $TOOLCHAIN =~ $SAFE_REGEX ]]; then
            echo 'Toolchain value in "./.current-toolchain" contains unexpected characters and further checks have been abandoned'
            exit 1
          fi

          echo "toolchain=$TOOLCHAIN" >> $GITHUB_OUTPUT

  # Toolchain should already be validated if updated by the action,
  # but it could be updated manually.
  validate-from-toolchain-format:
    needs: toolchain
    uses: ./.github/workflows/validate-toolchain-format.yml
    with:
      toolchain: ${{ needs.toolchain.outputs.toolchain }}

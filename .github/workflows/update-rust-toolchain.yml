name: update-rust-toolchain

on:
  workflow_call:
  schedule:
    - cron: "19 19 * * *"

concurrency:
  group: "${{ github.workflow }}"

env:
  RUSTUP_AUTO_INSTALL: "0"

  # DO NOT CHANGE MANUALLY
  # This is automatically updated via this action.
  FROM_TOOLCHAIN: "nightly-2026-01-08"

  # Token generated from (narrow down to just `0b10011/oxiplate`):
  # <https://github.com/settings/personal-access-tokens/new?name=oxiplate-toolchain-updater&description=Used%20to%20update%20the%20toolchain%20automatically%20in%20%60oxiplate%60%20via%20an%20Action.&expires_in=365&contents=write&pull_requests=write>
  GITHUB_TOKEN: ${{ secrets.PAT_TO_OPEN_PR_FOR_TOOLCHAIN_UPDATES }}

jobs:
  open-pr-with-updated-toolchain:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          depth: 0

      - name: Build name of latest possible toolchain
        id: toolchain
        run: echo 'toolchain=nightly-'$(date +'%Y-%m-%d') >> "$GITHUB_OUTPUT"

      # FROM_TOOLCHAIN should already be validated if updated by this action,
      # but it could be updated manually.
      - name: Validate toolchain names
        env:
          TO_TOOLCHAIN: &to_toolchain ${{ steps.toolchain.outputs.toolchain }}
          TOOLCHAIN_REGEX: "^nightly-[0-9]{4}-[0-9]{2}-[0-9]{2}$"
        run: |
          if [[ ! $FROM_TOOLCHAIN =~ $TOOLCHAIN_REGEX ]]; then
            echo "'$FROM_TOOLCHAIN' is not in the expected format '$TOOLCHAIN_REGEX'" 1>&2
            exit 1
          fi

          if [[ ! $TO_TOOLCHAIN =~ $TOOLCHAIN_REGEX ]]; then
            echo "'$TO_TOOLCHAIN' is not in the expected format '$TOOLCHAIN_REGEX'" 1>&2
            exit 1
          fi

      - name: Create branch
        id: create-branch
        env:
          BASE_BRANCH: &base_branch ${{ github.event.repository.default_branch }}
          # Branch name built from FROM_TOOLCHAIN
          # to ensure multiple PRs don't get opened
          # if the first PR doens't get merged
          # before this action runs again.
          FEATURE_BRANCH: &feature_branch "toolchain-update-from-${{ env.FROM_TOOLCHAIN }}"
        run: |
          if git checkout $FEATURE_BRANCH; then
            echo "Branch '$FEATURE_BRANCH' found; resetting to '$BASE_BRANCH' branch..."
            git reset --hard $BASE_BRANCH
          else
            echo "Branch '$FEATURE_BRANCH' does not exist; creating from '$BASE_BRANCH' branch..."
            git checkout -b $FEATURE_BRANCH
          fi

      - name: Update toolchain in files
        env:
          TO_TOOLCHAIN: *to_toolchain
        run: |
          sed --in-place --expression "s/$FROM_TOOLCHAIN/$TO_TOOLCHAIN/g" \
            ./justfile \
            ./rust-toolchain.toml \
            ./.github/workflows/book.yml \
            ./.github/workflows/tests-and-coverage.yml \
            ./.github/workflows/update-rust-nightly.yml

      - name: Commit and push
        env:
          TO_TOOLCHAIN: *to_toolchain
        run: |
          git status
          git diff
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit --message "chore: updated toolchain to $TO_TOOLCHAIN"
          git push --force-with-lease

      - name: Check if PR exists for branch
        id: pr_check
        env:
          BASE_BRANCH: &base_branch
          FEATURE_BRANCH: &feature_branch
        run: |
          PR_URLS=$(gh pr list \
            --base "$BASE_BRANCH" \
            --head "$FEATURE_BRANCH" \
            --json url \
            --jq '.[].url')
          
          if echo $PR_URLS | grep -q "."; then
            echo 'pr_exists=true' >> "$GITHUB_OUTPUT"
            echo 'Pull request already exists:'
            echo $PR_URLS
          else
            echo 'pr_exists=false' >> "$GITHUB_OUTPUT"
            echo 'No pull request currently exists'
          fi

      - name: Open PR
        if: steps.pr_check.outputs.pr_exists == 'false'
        env:
          TO_TOOLCHAIN: *to_toolchain
          PR_TYPE: ${{ steps.create-branch.outputs.pr-type }}
          LABEL: &label "rust toolchain update"
        run: |
          gh pr create \
          --title "Update toolchain to $TO_TOOLCHAIN from $FROM_TOOLCHAIN" \
          --body "Automatic toolchain update by `update-rust-nightly` action." \
          --assignee '0b10011' \
          --label $LABEL \
          --no-maintainer-edit

      - name: Update PR
        if: steps.pr_check.outputs.pr_exists == 'true'
        env:
          TO_TOOLCHAIN: *to_toolchain
          PR_TYPE: ${{ steps.create-branch.outputs.pr-type }}
          LABEL: *label
        run: |
          gh pr edit \
          --title "Update toolchain to $TO_TOOLCHAIN from $FROM_TOOLCHAIN" \
          --body "Automatic toolchain update by `update-rust-nightly` action."

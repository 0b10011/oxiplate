name: update-rust-toolchain

on:
  workflow_dispatch:
  schedule:
    - cron: "19 19 * * *"

concurrency:
  group: "${{ github.workflow }}"

env:
  RUSTUP_AUTO_INSTALL: "0"

  # Token generated from (narrow down to just `0b10011/oxiplate`):
  # <https://github.com/settings/personal-access-tokens/new?name=oxiplate-toolchain-updater&description=Used%20to%20update%20the%20toolchain%20automatically%20in%20%60oxiplate%60%20via%20an%20Action.&expires_in=365&contents=write&pull_requests=write&workflows=write>
  GITHUB_TOKEN: ${{ secrets.PAT_TO_OPEN_PR_FOR_TOOLCHAIN_UPDATES }}

jobs:
  build-from-toolchain:
    uses: ./.github/workflows/existing-toolchain.yml

  build-to-toolchain:
    uses: ./.github/workflows/newest-toolchain.yml

  open-pr-with-updated-toolchain:
    needs: [
      build-from-toolchain,
      build-to-toolchain,
    ]
    permissions:
      contents: write
      pull-requests: write
    env:
      FROM_TOOLCHAIN: ${{ needs.build-from-toolchain.outputs.toolchain }}
      TO_TOOLCHAIN: ${{ needs.build-to-toolchain.outputs.toolchain }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Enable color output in git
        run: git config --global color.ui always

      - name: Create branch
        id: create-branch
        env:
          BASE_BRANCH: &base_branch ${{ github.event.repository.default_branch }}
          # Branch name built from FROM_TOOLCHAIN
          # to ensure multiple PRs don't get opened
          # if the first PR doens't get merged
          # before this action runs again.
          FEATURE_BRANCH: &feature_branch "toolchain-update-from-${{ env.FROM_TOOLCHAIN }}"
        run: |
          if git checkout $FEATURE_BRANCH; then
            echo "Branch '$FEATURE_BRANCH' found; resetting to '$BASE_BRANCH' branch..."
            git reset --hard $BASE_BRANCH
          else
            echo "Branch '$FEATURE_BRANCH' does not exist; creating from '$BASE_BRANCH' branch..."
            git checkout -b $FEATURE_BRANCH
          fi

      - name: Update toolchain in files
        run: |
          sed --in-place --expression "s/$FROM_TOOLCHAIN/$TO_TOOLCHAIN/g" \
            ./justfile \
            ./rust-toolchain.toml \
            ./.github/workflows/book.yml \
            ./.github/workflows/tests-and-coverage.yml \
            ./.github/workflows/update-rust-toolchain.yml

      - name: Commit and push
        env:
          FEATURE_BRANCH: *feature_branch
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git status
          git diff --staged
          git commit --message "chore: updated toolchain to $TO_TOOLCHAIN"
          git push --force-with-lease --set-upstream origin "$FEATURE_BRANCH"

      - name: Check if PR exists for branch
        id: pr_check
        env:
          BASE_BRANCH: *base_branch
          FEATURE_BRANCH: *feature_branch
        run: |
          PR_URLS=$(gh pr list \
            --base "$BASE_BRANCH" \
            --head "$FEATURE_BRANCH" \
            --json url \
            --jq '.[].url')
          
          if echo $PR_URLS | grep -q "."; then
            echo 'pr_exists=true' >> "$GITHUB_OUTPUT"
            echo 'Pull request already exists:'
            echo $PR_URLS
          else
            echo 'pr_exists=false' >> "$GITHUB_OUTPUT"
            echo 'No pull request currently exists'
          fi

      - name: Open PR
        if: steps.pr_check.outputs.pr_exists == 'false'
        env:
          PR_TYPE: ${{ steps.create-branch.outputs.pr-type }}
          LABEL: &label "rust toolchain update"
        run: |
          gh pr create \
          --title "Update toolchain to $TO_TOOLCHAIN from $FROM_TOOLCHAIN" \
          --body 'Automatic toolchain update by "update-rust-toolchain" action.' \
          --assignee '0b10011' \
          --label $LABEL \
          --no-maintainer-edit

      - name: Update PR
        if: steps.pr_check.outputs.pr_exists == 'true'
        env:
          PR_TYPE: ${{ steps.create-branch.outputs.pr-type }}
          LABEL: *label
        run: |
          gh pr edit \
          --title "Update toolchain to $TO_TOOLCHAIN from $FROM_TOOLCHAIN" \
          --body 'Automatic toolchain update by "update-rust-nightly" action.'
